<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz | QuizlyNotes</title>
    <link rel="stylesheet" href="static/css/style.css">
    <link rel="stylesheet" href="static/css/quiz.css">
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2" defer></script>
    <script src="static/js/script.js" defer></script>


</head>

<body class="app-shell">
    {% include "menu-bar.html" %}
    <main class="app-main quiz-layout">
        <section class="page-header">
            <div>
                <span class="page-badge">Quiz</span>
                <h1>Test your understanding</h1>
                <p>Work through each note set and interactive question to reinforce what you just learned.</p>
            </div>
        </section>

        <div class="quiz-progress">
            <div class="quiz-progress__track">
                <div id="progress-bar" class="quiz-progress__bar"></div>
            </div>
        </div>

        {% if data %}
        {% set step = namespace(count=0) %}
        {% for main_title, notes in data|groupby('main_title') %}
        {% set title_id = main_title|replace(' ', '_')|lower %}
        {% set is_active = step.count == 0 %}
        <section id="note-{{ title_id }}" class="quiz-step card-nav quiz-card{% if is_active %} is-active{% endif %}" {% if not is_active %}hidden{% endif %}>
            <div class="quiz-card__header">
                <h2>{{ main_title }}</h2>
                <div class="quiz-card__controls">
                    <button type="button" onclick="previousCard('{{ title_id }}')" aria-label="Previous card">
                        <img src="static/images/back-arrow.svg" alt="Previous">
                    </button>
                    <button type="button" onclick="nextCard('{{ title_id }}')" aria-label="Next card">
                        <img src="static/images/foward-arrow.svg" alt="Next">
                    </button>
                </div>
            </div>
            <div class="quiz-card__body">
                {% for note in notes %}
                {% if loop.first %}
                <div class="sub-card note-card" id="{{ title_id }}{{ loop.index0 }}">
                {% else %}
                <div class="sub-card note-card" id="{{ title_id }}{{ loop.index0 }}" style="display: none;">
                {% endif %}
                    <h3>{{ note.sub_title }}</h3>
                    <ul class="quiz-card__list">
                        {% for line in note.content %}
                        {% set level = line | length - line.lstrip('-') | length %}
                        <li style="margin-left: {{ level * 20 }}px;">{{ line | lstrip('- ') }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endfor %}
            </div>
            <div class="quiz-card__footer">
                <div id="card_num_container{{ title_id }}" class="card-num">
                    <span id="card_num_{{ title_id }}">0</span>
                </div>
                <button class="btn-secondary btn" data-role="next" onclick="next('note-{{ title_id }}')">Continue</button>
            </div>
        </section>
        {% set step.count = step.count + 1 %}

        {% for q in questions %}

        {% if q.title == main_title %}
        {% set question_index = step.count %}
        {% set q_id = 'question-' ~ title_id ~ '-' ~ question_index %}
        {% set is_question_active = step.count == 0 %}
        {% if q.type == "fill-in-blank" %}
        <section class="quiz-step question quiz-card{% if is_question_active %} is-active{% endif %}" id="{{ q_id }}" {% if not is_question_active %}hidden{% endif %}>
            <div class="quiz-card__body">
                <h3 class="quiz-question">{{ q.type }}</h3>
                <form method="post" class="quiz-form">
                    <p>
                        {% set parts = q.question.split("{blank}") %}
                        {% for part in parts %}
                        {{ part }}
                        {% if not loop.last %}
                        <input class="blank-textbox" type="text" name="answer_{{ loop.index0 }}" size="10"
                            data-answer="{{ q.answer[loop.index0] }}" />
                        {% endif %}
                        {% endfor %}
                    </p>
                </form>
            </div>
            <div class="quiz-card__footer">
                <button class="btn" data-role="next" onclick="next('{{ q_id }}')">Continue</button>
            </div>
        </section>

        {% elif q.type == "true-false" %}
        <section class="quiz-step question quiz-card{% if is_question_active %} is-active{% endif %}" id="{{ q_id }}" {% if not is_question_active %}hidden{% endif %}>
            <div class="quiz-card__body">
                <h3 class="quiz-question">{{ q.question }}</h3>
                <form class="quiz-options">
                    <button type="button" class="multi-choice-btn" onclick="checkAnswerTF(event, '{{ q.answer }}')"
                        id="answer_{{ loop.index }}_T" value="true">True</button>
                    <button type="button" class="multi-choice-btn" onclick="checkAnswerTF(event, '{{ q.answer }}')"
                        id="answer_{{ loop.index }}_F" value="false">False</button>
                </form>
            </div>
            <div class="quiz-card__footer">
                <button class="btn" data-role="next" onclick="next('{{ q_id }}')">Continue</button>
            </div>
        </section>

        {% elif q.type == "multiple-choice" %}
        <section class="quiz-step question quiz-card{% if is_question_active %} is-active{% endif %}" id="{{ q_id }}" {% if not is_question_active %}hidden{% endif %}>
            <div class="quiz-card__body">
                <h3 class="quiz-question">{{ q.question }}</h3>
                <form class="quiz-options">
                    {% set options = q.options | shuffle %}
                    {% for opt in options %}
                    <button type="button" class="multi-choice-btn" onclick="checkAnswerTF(event, '{{ q.answer }}')"
                        value="{{ opt }}">{{ opt }}</button>
                    {% endfor %}
                </form>
            </div>
            <div class="quiz-card__footer">
                <button class="btn" data-role="next" onclick="next('{{ q_id }}')">Continue</button>
            </div>
        </section>

        {% elif q.type == "short-answer" %}
        <section class="quiz-step question quiz-card{% if is_question_active %} is-active{% endif %}" id="{{ q_id }}" {% if not is_question_active %}hidden{% endif %}>
            <div class="quiz-card__body">
                <h3 class="quiz-question">{{ q.question }}</h3>
                <form method="post" class="quiz-form">
                    <textarea name="answer_{{ loop.index }}" class="answer-box" data-answer="{{ q.answer }}" rows="3"
                        cols="40"></textarea>
                </form>
            </div>
            <div class="quiz-card__footer">
                <button class="btn" data-role="next" onclick="next('{{ q_id }}')">Continue</button>
            </div>
        </section>

        {% elif q.type == "ordering" %}
        <section class="quiz-step question quiz-card{% if is_question_active %} is-active{% endif %}" id="{{ q_id }}" {% if not is_question_active %}hidden{% endif %}>
            <div class="quiz-card__body">
                <h3 class="quiz-question">{{ q.question }}</h3>
                <form class="quiz-ordering" onsubmit="checkOrdering(event)" data-answer='{{ q.answer |tojson }}'>
                    <ol>
                        {% set options = q.options | shuffle %}
                        {% for opt in options %}
                        <li draggable="true" class="draggable">
                            {{ opt }}
                        </li>
                        {% endfor %}
                    </ol>
                    <button type="submit" class="btn-secondary btn">Confirm order</button>
                </form>
            </div>
            <div class="quiz-card__footer">
                <button class="btn" data-role="next" onclick="next('{{ q_id }}')">Continue</button>
            </div>
        </section>
        {% endif %}

        {% set step.count = step.count + 1 %}
        {% endif %}

        {% endfor %}

        {% endfor %}
        {% endif %}
        <form method="POST" action="/end-quiz" class="quiz-finish">
            <input type="hidden" name="set-id" value="{{ set_id }}">
            <input type="hidden" name="final-score" id="final-score">

            <button type="submit" id="finish-quiz-btn" class="btn">
                Finish quiz
            </button>
        </form>
    </main>

</body>

</html>
